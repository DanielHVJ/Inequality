---
title: "Clean data"
output: html_document
---

```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

```{r, message = off}
library(tidyverse)
library(readxl)
library(lmtest)

#library(psych)
```


```{r}
ine <- read_excel("F:/INEQUALITY/2020/FINAL 04.xlsx", sheet = "log (2)")

# ine <-  as.data.frame(ine)
# ine2 <- drop_na(ine)

#inef <- drop_na(ineD)
```

```{r}
# ine2$year <- NULL
# ine2$idem <- NULL
# ine2$debt_g <- NULL
# se va el grupo de deuda

inst <- ine[c(1:667), c(1:2,54:66)]
base <- ine[c(1:667), c(1:53)]
base <- subset(base, select=-c(pop, GDP_curr, GDP_con))
ineq <- ine[c(1:667), c(74:90)]
saving_tic <- ine[c(1:667), c(67:73)]

```

```{r}
skewedVars<- NA
library(moments) # for skewness()
for(i in names(ine)){
       skewVal <- skewness(ine[,i])
       print(paste(i, skewVal, sep = ": "))
       if(abs(skewVal) > 1.15){
         skewedVars <- c(skewedVars, i)
       }
}

# solo tomar td_fe
# inst en growth y graficos aparte
```

```{r}
library(purrr)
library(tidyr)
library(ggplot2)
library(ggthemes)

rest %>% keep(is.numeric) %>% 
  gather() %>% ggplot(aes(value)) +
    facet_wrap(~ key , scales = "free") +
    geom_histogram(colour="blue") + theme_wsj(base_size = 8)


# Boxplots

inst %>% keep(is.numeric) %>% 
  gather() %>% ggplot(aes(value)) +
    facet_wrap(~ key , scales = "free") +
    geom_histogram(colour="blue", fill='gray') + theme_wsj(base_size = 8)

saving_tic %>% keep(is.numeric) %>% 
  gather() %>% ggplot(aes(value)) +
    facet_wrap(~ key , scales = "free") +
    geom_histogram(colour="blue", fill='gray') + theme_wsj(base_size = 8)

ineq %>% keep(is.numeric) %>% 
  gather() %>% ggplot(aes(value)) +
    facet_wrap(~ key , scales = "free") +
    geom_boxplot(colour="blue", fill='gray') + theme_wsj(base_size = 8)

```

limpiar: gro_GDPpc

```{r}
library(corrplot)

# ine2$year <- NULL
ine2 <- subset(ine, select=-c(pop, GDP_curr, GDP_con))

base %>% keep(is.numeric) -> base_cor
inst %>% keep(is.numeric) -> inst_cor

# adding Gini_net
inst_cor$Gini_net = ine$Gini_net
saving_tic$Gini_net = ine$Gini_net
ineq$Gini_net = ine$Gini_net

corr_b <- cor(na.omit(base_cor))
corr_ins <- cor(na.omit(inst_cor))
corr_sa <- cor(na.omit(saving_tic))
corr_ineq <- cor(na.omit(ineq))

row_indic <- apply(corr_b, 1, function(x) sum(x > 0.60 | x < -0.60) > 1)
row_indic2 <- apply(corr_ins, 1, function(x) sum(x > 0.40 | x < -0.40) > 1)
row_indic3 <- apply(corr_sa, 1, function(x) sum(x > 0.50 | x < -0.50) > 1)
row_indic4 <- apply(corr_ineq, 1, function(x) sum(x > 0.75 | x < -0.75) > 1)

corr <- corr_b[row_indic ,row_indic]
corr2 <- corr_ins[row_indic2 ,row_indic2]
corr3 <- corr_sa[row_indic3 ,row_indic3]
corr4 <- corr_ineq[row_indic4 ,row_indic4]

corrplot(corr, method="square", diag = F,order = 'hclust', tl.cex = .8)
corrplot(corr2, method="ellipse", diag = F,order = 'hclust', tl.cex = .8)
corrplot(corr3, method="ellipse", diag = F,order = 'hclust', tl.cex = .8)
corrplot(corr4, method="ellipse", diag = F,order = 'hclust', tl.cex = .8)
```
le_female, net_len_w/i, soc_payable, gov_ex, soc_prot, td_female, tertiary_ed, voice, ruleoflaw, goveff, soc_proc_ex_pen, trade, 

```{r}
plotHist <- function(data_in, i) {
    data <- data.frame(x=data_in[[i]])
    p <- ggplot(data=data, aes(x=factor(x))) + stat_count() + xlab(colnames(data_in)[i]) + theme_grey() + 
   theme(axis.text.x = element_text(angle = 90, hjust =1))
    return (p)
}
```

```{r}
library(gridExtra)
doPlots <- function(data_in, fun, ii, ncol=2) {
    pp <- list()
    for (i in ii) {
        p <- fun(data_in=data_in, i=i)
        pp <- c(pp, list(p))
    }
    do.call("grid.arrange", c(pp, ncol=ncol))
}
```

```{r}
plotDen <- function(data_in, i){
    data <- data.frame(x=data_in[[i]], y = data_in$Gini_net)
    p <- ggplot(data= data) + geom_bar(aes(x = x), stat = 'density', size = 1, alpha = 0.7) + xlab(paste0((colnames(data_in)[i]), '\n', 'Skewness:',
round(skewness(data_in[[i]], na.rm = T), 2))) 
return(p)
    }
```

```{r}
doPlots(ine2, fun = plotDen, ii = 11:19, ncol = 3)
```

```{r}
plotCorr <- function(data_in, i){
data <- data.frame(x = data_in[[i]], y= data_in$Gini_net)
p <- ggplot(data, aes(x = x, y = y)) + geom_point(shape = 1, na.rm = T) +  geom_smooth(method = lm ) + xlab(paste0(colnames(data_in)[i], 
  '\n', 'R-Squared: ', round(cor(data_in[[i]], data$y, 
 use = 'complete.obs'), 2))) 
 return(suppressWarnings(p))
}
```

```{r}
highcorr_b <- c(names(corr_b[,'Gini_net'])[which(corr_b[,'Gini_net'] > 0.05)],
    names(corr_b[,'Gini_net'])[which(corr_b[,'Gini_net'] < -0.05)])

highcorr_ins <- c(names(corr_ins[,'Gini_net'])[which(corr_ins[,'Gini_net'] > 0.15)],
    names(corr_ins[,'Gini_net'])[which(corr_ins[,'Gini_net'] < -0.15)])

highcorr_ineq <- c(names(corr_ineq[,'Gini_net'])[which(corr_ineq[,'Gini_net'] > 0.75)],
    names(corr_ineq[,'Gini_net'])[which(corr_ineq[,'Gini_net'] < -0.75)])

highcorr_sa <- c(names(corr_sa[,'Gini_net'])[which(corr_sa[,'Gini_net'] > 0.15)],
    names(corr_sa[,'Gini_net'])[which(corr_sa[,'Gini_net'] < -0.15)])

data_corr <- ine2[, highcorr_b]
doPlots(data_corr, fun = plotCorr, ii = c(2,10,7:9, 13))

data_corr_ins <- ine2[, highcorr_ins]
doPlots(data_corr_ins, fun = plotCorr, ii = c(1,4:8))

data_corr_sa <- ine2[, highcorr_sa]
doPlots(data_corr_sa, fun = plotCorr, ii = c(2:6))

```

```{r}
a <- c(names(data_corr))
a = a[a!= 'year'] 
b <- c(names(data_corr_ins)) 
b = b[b!= 'Gini_net'] 
c = c(names(data_corr_sa))
c = c[c!= 'Gini_net'] 

da = c(a,b,c)
final <- ine %>% select(1:3)
final <- cbind(final,ine[, da])
```

```{r}
library("xlsx")

write.xlsx(final, file = "final.xlsx", sheetName="DAN", col.names = T)
```


https://rpubs.com/nischalthapa/267813


```{r}
# PANEL GROWTH RATE

library(tidyverse)  # Love dplyr!

my.panel.df <- ine%>%
  arrange(idem, year) %>%  # Sort by firm and then by year
  group_by(idem) %>%  # Tell dplyr to go within each firm
  mutate(sg.diff = G99 - lag(G99), 
         sgr = (100*(sg.diff/lag(G99))),
         dgr.diff = G99 - lag(AVGTOP), 
         dgr = (100*(dgr.diff/lag(AVGTOP)))) 
```


Data transformation negative logs

https://discuss.analyticsvidhya.com/t/methods-to-deal-with-zero-values-while-performing-log-transformation-of-variable/2431/8

https://blogs.sas.com/content/iml/2011/04/27/log-transformations-how-to-handle-negative-data-values.html

le_female, net_len_w/i, soc_payable, gov_ex, soc_prot, td_female, tertiary_ed, voice, ruleoflaw, goveff, soc_proc_ex_pen, trade, 

